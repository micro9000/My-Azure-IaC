pool:
  vmImage: ubuntu-latest

variables:
  - group: SharedResources
  - name: ServiceConnection
    value: "Pay-As-You-Go"
  - name: INFRA_DIR
    value: "Temporary-Build-Agent/Azure-IaC"

# https://learn.microsoft.com/en-us/azure/devops/pipelines/process/pipeline-triggers?view=azure-devops
resources:
  pipelines:
  - pipeline: buildSharedResources # Name of the pipeline resource.
    source: build-shared-resources # The name of the pipeline referenced by this pipeline resource.
    trigger: true

jobs:
  - job: ApplyAzureInfra
    steps:
    - checkout: self
      displayName: 'Checkout repository'

    - task: Bash@3
      displayName: "Dump environment variables and list files"
      inputs:
        workingDirectory: '$(Pipeline.Workspace)'
        targetType: inline
        script: |
          printenv
          ls -la

    - task: TerraformInstaller@1
      displayName: Install Terraform 1.6.3
      inputs:
        terraformVersion: 1.6.3
    
    - task: TerraformTaskV4@4
      displayName: Initialize Terraform
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(ServiceConnection)'
        backendAzureRmResourceGroupName: '$(resourceGroupName)'
        backendAzureRmStorageAccountName: '$(tfStateStorage)'
        backendAzureRmContainerName: 'temporary-build-agent-image-builder'
        backendAzureRmKey: 'terraform.tfstate'

    - task: TerraformTaskV4@4
      name: terraformPlan
      displayName: Create Terraform Plan
      inputs:
        provider: 'azurerm'
        command: 'plan'
        commandOptions: '-out main.tfplan'
        environmentServiceNameAzureRM: '$(ServiceConnection)'
        workingDirectory: '$(Build.SourcesDirectory)/$(INFRA_DIR)'

    # Only runs if the 'terraformPlan' task has detected changes the in state. 
    - task: TerraformTaskV4@4
      displayName: Apply Terraform Apply
      condition: eq(variables['terraformPlan.changesPresent'], 'true')
      inputs:
        provider: 'azurerm'
        command: 'apply'
        commandOptions: 'main.tfplan'
        environmentServiceNameAzureRM: '$(ServiceConnection)'
        workingDirectory: '$(Build.SourcesDirectory)/$(INFRA_DIR)'